name: test-hirehub-adaptive

services:
  db:
    image: postgres:15-alpine
    container_name: test-hirehub-adaptive-db
    ports:
      - "5433:5432"  # Use 5433 to avoid conflicts with other PostgreSQL instances
    environment:
      - POSTGRES_USER=hirehub
      - POSTGRES_PASSWORD=hirehub_password
      - POSTGRES_DB=hirehub
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hirehub"]
      interval: 5s
      timeout: 5s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    container_name: test-hirehub-adaptive-qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC (optional)
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333

  searxng:
    build:
      context: ./searxng
      dockerfile: Dockerfile
    container_name: test-hirehub-adaptive-searxng
    ports:
      - "8888:8080"
    volumes:
      - ./searxng:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=http://localhost:8888/
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  perplexica:
    build:
      context: ./perplexica
      dockerfile: Dockerfile
    container_name: test-hirehub-perplexica
    ports:
      - "3002:3000"  # Perplexica web UI
      # Note: Not exposing 8080 - using external SearXNG at searxng:8080
    volumes:
      - perplexica_data:/home/perplexica/data
      - perplexica_uploads:/home/perplexica/uploads
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SEARXNG_API_URL=http://searxng:8080  # Use existing SearXNG
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      searxng:
        condition: service_healthy

  api:
    build: .
    container_name: test-hirehub-adaptive-api
    env_file:
      - .env
    ports:
      - "8001:8000"
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - .:/app
    depends_on:
      db:
        condition: service_healthy
      qdrant:
        condition: service_started
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access host's localhost from container

  parakeet:
    build:
      context: ./parakeet-service
      dockerfile: Dockerfile
    container_name: test-hirehub-adaptive-parakeet
    ports:
      - "8002:8002"
    volumes:
      - parakeet_models:/app/models  # Cache downloaded models
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - NEMO_CACHE_DIR=/app/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  benchmark:
    build: .
    env_file:
      - .env
    volumes:
      - .:/app
    command: python scripts/benchmark_toon.py

  benchmark-json:
    build: .
    env_file:
      - .env
    volumes:
      - .:/app
    command: python scripts/benchmark_json.py

volumes:
  postgres_data:
  qdrant_storage:
  parakeet_models:
  perplexica_data:
  perplexica_uploads:
